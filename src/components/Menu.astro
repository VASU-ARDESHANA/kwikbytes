---
import { getCollection } from "astro:content";
import { siteLang, siteCurrency } from "~/data/config";
const plates = await getCollection("plates");
const siteLangFormat = siteLang.replace("_", "-");
---

<div id="plate-nav-wrapper" class="mb-20 sticky top-8 z-10">
	<nav class="bg-brand-green text-white sm:rounded-full max-w-5xl mx-auto">
		<div class="swiper-plates w-auto overflow-hidden">
			<ul id="plate-nav" class="px-2.5 py-3 swiper-wrapper">
				{
					plates.map((plate) => (
						<li class="swiper-slide !w-auto last:mr-5">
							<a
								href={`#${plate.data.slug}`}
								class="rounded-full px-2 py-1 transition font-medium select-none"
								data-category-link={plate.data.slug}
							>
								{plate.data.prettyName}
							</a>
						</li>
					))
				}
			</ul>
		</div>
	</nav>
</div>

<div class="grid grid-cols-1 gap-y-16">
	{
		plates.map((plate) => (
			<div
				id={plate.data.slug}
				class="space-y-16 scroll-mt-10"
				data-category-section={plate.data.slug}
			>
				<div class="flex flex-col items-center gap-2 max-w-lg mx-auto text-balance text-center" style="margin-bottom: 40;">
					<h3 class="h4 text-brand-green">
						{plate.data.prettyName}
					</h3>
					<p>{plate.data.description}</p>
				</div>
				{plate.data.varieties && plate.data.varieties.length > 0 && plate.data.prettyLayout === "version" && (
					<div class="max-w-5xl mx-auto -mt-8 mb-8">
						<div class="flex justify-end gap-4 sm:gap-8 lg:gap-12">
							{plate.data.varieties.map((variety) => (
								<div class="text-right min-w-[70px] sm:min-w-[80px]">
									<h6 class="font-bold text-base sm:text-lg lg:text-xl text-brand-green/70">
										{variety.name}
									</h6>
									{variety.description && (
										<p class="text-gray-600 text-xs sm:text-sm">
											{variety.description}
										</p>
									)}
								</div>
							))}
						</div>
					</div>
				)}
				{plate.data.varieties && plate.data.varieties.length > 0 && plate.data.prettyLayout === "normal" && (
					<div class="max-w-5xl mx-auto mb-8">
						<div class="flex justify-center gap-4 sm:gap-8 lg:gap-12">
							{plate.data.varieties.map((variety) => (
								<div class="text-center">
									<h5 class="font-bold text-xl text-brand-green/70">
										{variety.name}
									</h5>
									<p class="text-gray-600">
										{variety.description}
									</p>
								</div>
							))}
						</div>
					</div>
				)}

				<dl class="max-w-5xl mx-auto">
					{plate.data.prettyLayout === "version" ? (
						<div class="grid grid-cols-1 gap-4 sm:gap-6">
							{plate.data.plates.map((item) => (
								<div>
									<dt>
										<div class="flex justify-between items-center gap-2 sm:gap-4">
											<span class="font-bold text-lg sm:text-xl lg:text-2xl tracking-wide flex-1">
												{item.name}
											</span>
											<div class="flex gap-4 sm:gap-8 lg:gap-12">
												<span class="font-medium text-base sm:text-lg min-w-[70px] sm:min-w-[80px] text-right">
													{new Intl.NumberFormat(siteLang, {
														style: "currency",
														currency: siteCurrency,
														minimumFractionDigits: 0,
														maximumFractionDigits: 0,
													}).format(item.price)}
												</span>
												{item.price2 && (
													<span class="font-medium text-base sm:text-lg min-w-[70px] sm:min-w-[80px] text-right">
														{new Intl.NumberFormat(siteLang, {
															style: "currency",
															currency: siteCurrency,
															minimumFractionDigits: 0,
															maximumFractionDigits: 0,
														}).format(item.price2)}
													</span>
												)}
											</div>
										</div>
									</dt>
									{item.description && (
										<dd>
											<p class="mt-2 text-gray-500 tracking-wide leading-normal text-balance">
												{item.description}
											</p>
										</dd>
									)}
								</div>
							))}
						</div>
					) : (
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-x-16 xl:gap-x-32">
							{plate.data.plates.map((item) => (
								<div>
									<dt>
										<div class="flex justify-between items-center">
											<span class="font-bold text-2xl tracking-wide">
												{item.name}
											</span>
											<span class="font-medium text-lg">
												{new Intl.NumberFormat(siteLang, {
													style: "currency",
													currency: siteCurrency,
													minimumFractionDigits: 0,
													maximumFractionDigits: 0,
												}).format(item.price)}{" "}
											</span>
										</div>
									</dt>
									<dd>
										<p class="mt-2 text-gray-500 tracking-wide leading-normal text-balance">
											{item.description}
										</p>
									</dd>
								</div>
							))}
						</div>
					)}
				</dl>
			</div>
		))
	}
</div>

<style>
	@media screen and (min-width: 0px) and (max-width: 640px) {
		#plate-nav-wrapper {
			right: 0;
			left: 0;
			top: 0;
			margin-left: -50vw;
			margin-right: -50vw;
			max-width: 100vw;
			width: 100vw;
		}
	}
</style>

<script>
	import Swiper from "swiper";
	import "swiper/css";

	document.addEventListener("astro:page-load", () => {
		const swiperPlates = document.querySelector(
			".swiper-plates",
		) as HTMLElement;
		const swiper = new Swiper(swiperPlates, {
			loop: false,
			spaceBetween: 32,
			slidesPerView: "auto",
		});

		const categoryLinks = document.querySelectorAll("[data-category-link]");
		const categorySections = document.querySelectorAll(
			"[data-category-section]",
		);
		let activeLink: Element | null = null;
		let isNavigatingByClick = false;

		categoryLinks.forEach((link) => {
			link.classList.add("hover:bg-white/10");
		});

		function setActiveCategory(id: string) {
			categoryLinks.forEach((link) => {
				link.classList.remove("bg-white", "text-brand-green");
				link.classList.add("hover:bg-white/10");
			});

			const currentLink = document.querySelector(
				`[data-category-link="${id}"]`,
			);
			if (currentLink) {
				currentLink.classList.add("bg-white", "text-brand-green");
				currentLink.classList.remove("hover:bg-white/10");
				activeLink = currentLink;

				const linkIndex =
					Array.from(categoryLinks).indexOf(currentLink);
				if (linkIndex !== -1) {
					swiper.slideTo(linkIndex);
				}
			}
		}

		categoryLinks.forEach((link) => {
			link.addEventListener("click", (e) => {
				const targetId = (link as HTMLElement).dataset.categoryLink;
				if (targetId) {
					isNavigatingByClick = true;
					setActiveCategory(targetId);

					setTimeout(() => {
						isNavigatingByClick = false;
					}, 1000);
				}
			});
		});

		const observer = new IntersectionObserver(
			(entries) => {
				if (isNavigatingByClick) return;

				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						const sectionId = (entry.target as HTMLElement).dataset
							.categorySection;
						if (sectionId) {
							setActiveCategory(sectionId);
						}
					}
				});
			},
			{ rootMargin: "-20% 0px -60% 0px", threshold: 0 },
		);

		categorySections.forEach((section) => {
			observer.observe(section);
		});

		const setInitialActiveCategory = () => {
			if (window.location.hash) {
				const id = window.location.hash.substring(1);
				setActiveCategory(id);
			} else if (categorySections.length > 0) {
				const firstSectionId = (categorySections[0] as HTMLElement)
					.dataset.categorySection;
				if (firstSectionId) {
					setActiveCategory(firstSectionId);
				}
			}
		};

		setInitialActiveCategory();
	});
</script>